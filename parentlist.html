<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parents of Assigned Students</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <style>
      * {
        padding: 0;
        margin: 0;
        box-sizing: border-box;
        list-style-type: none;
        text-decoration: none;
        font-family: Futura, "Trebuchet MS", Arial, sans-serif;
      }

      .sidebar {
        width: 345px;
        position: fixed;
        left: 0;
        top: 0;
        height: 100%;
        background: #2c98f0;
        z-index: 100;
        transition: width 300ms;
      }

      .sidebar-brand {
        height: 90px;
        padding: 1rem 0rem 1rem 2rem;
        color: #fff;
      }

      .sidebar-menu {
        margin-top: 1rem;
      }

      .sidebar-menu li {
        width: 100%;
        margin-bottom: 1.3rem;
        padding-left: 2rem;
      }

      .sidebar-menu a {
        padding-left: 1rem;
        display: block;
        color: #fff;
        font-size: 1.1rem;
        padding-top: 1rem;
      }

      .sidebar-menu a.active {
        background: #fff;
        padding-top: 1rem;
        padding-bottom: 1rem;
        color: #2c98f0;
        border-radius: 30px 0px 0px 30px;
      }

      .sidebar-menu a:hover {
        background: #fff;
        padding-top: 1rem;
        padding-bottom: 1rem;
        color: #2c98f0;
        border-radius: 30px 0px 0px 30px;
        transition-duration: 0.5s;
      }

      .main-content {
        transition: margin-left 300ms;
        margin-left: 345px;
        padding: 2rem;
      }

      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
      }

      .container {
        max-width: 550px;
        margin: 50px auto;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }

      h2 {
        text-align: center;
        color: #333;
      }

      .parent-item {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .parent-item:hover {
        background-color: #f0f0f0;
      }

      .chat-btn {
        padding: 5px 10px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      @media only screen and (max-width: 768px) {
        .sidebar {
          width: 70px;
        }

        .main-content {
          margin-left: 70px;
        }
      }
    </style>
  </head>
  <body>
    <input type="checkbox" id="nav-toggle" />
    <div class="sidebar">
      <div class="sidebar-brand">
        <h2><span>Smart Tutor</span></h2>
      </div>
      <div class="sidebar-menu">
        <ul>
          <li>
            <a href="tutor_dashboard.html"
              ><span class="las la-home"></span> <span>Dashboard</span></a
            >
          </li>
          <li>
            <a href="tutor_manage_student_requests.html"
              ><span class="las la-user"></span>
              <span>Manage Student Requests</span></a
            >
          </li>
          <li>
            <a href="parentlist.html" class="active"
              ><span class="fa-solid fa-comments"></span>
              <span>Parents of Assigned Students</span></a
            >
          </li>
          <li>
            <a href="created_communities.html"
              ><span class="fa-solid fa-people-group"></span>
              <span>Created Communities</span></a
            >
          </li>
          <li>
            <a href="tutor_create_community.html"
              ><span class="fa-solid fa-people-roof"></span>
              <span>Create New Community</span></a
            >
          </li>
          <li>
            <a
              href="tutor_start_online_session.html"
              onclick="saveUserToSession()"
            >
              <span class="fa-solid fa-video"></span>
              <span>Create a Session</span>
            </a>
          </li>
          <li>
            <a
              href="tutor_join_online_session.html"
              onclick="saveUserToSession()"
            >
              <span class="fa-solid fa-video"></span>
              <span>Join a Session</span>
            </a>
          </li>
          <li>
            <a href="loginpage.html"
              ><span class="fa-solid fa-right-from-bracket"></span>
              <span>Logout</span></a
            >
          </li>
        </ul>
      </div>
    </div>

    <div class="main-content">
      <div class="container">
        <h2>Parents of Assigned Students</h2>
        <div id="parentList"></div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Retrieve tutor details from session storage
        const tutorDetails = sessionStorage.getItem("tutorDetails");

        if (!tutorDetails) {
          console.error("Tutor details not found in session storage.");
          document.getElementById("parentList").innerHTML =
            "<p>Error: Tutor details missing.</p>";
          return;
        }

        // Parse stored tutor details and get Tutor_ID
        const tutor = JSON.parse(tutorDetails);
        const tutorId = tutor.Tutor_ID;

        if (!tutorId) {
          console.error("Tutor ID is missing in stored tutor details.");
          document.getElementById("parentList").innerHTML =
            "<p>Error: Tutor ID missing.</p>";
          return;
        }

        // Fetch list of parents assigned to this tutor
        fetch(`/getParentsForTutor/${tutorId}`)
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            const parentList = document.getElementById("parentList");
            parentList.innerHTML = "";

            if (data.length === 0) {
              parentList.innerHTML = "<p>No assigned students found.</p>";
              return;
            }

            data.forEach((parent) => {
              const div = document.createElement("div");
              div.classList.add("parent-item");

              const button = document.createElement("button");
              button.textContent = "Open Chat";
              button.classList.add("chat-btn");

              // Open chat with parent
              button.onclick = () => {
                fetch("/api/chat/getRoom", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ parentId: parent.Parent_ID, tutorId }),
                })
                  .then((response) => response.json())
                  .then((room) => {
                    if (room.chatId) {
                      window.location.href = `/tutorchat.html?roomId=${room.chatId}&parentId=${parent.Parent_ID}`;
                    } else {
                      console.error("Failed to get or create chat room");
                    }
                  })
                  .catch((error) =>
                    console.error("Error fetching chat room:", error)
                  );
              };

              div.innerHTML = `<span>Parent of ${
                parent.Student_Name || "Unknown"
              } (ID: ${parent.Parent_ID})</span>`;
              div.appendChild(button);

              parentList.appendChild(div);
            });
          })
          .catch((error) =>
            console.error("Error fetching parent list:", error)
          );
      });
    </script>
  </body>
</html>
