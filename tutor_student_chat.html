<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tutor Student Chat</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f0f2f5;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100vh;
        justify-content: center;
      }
      .chat-container {
        width: 400px;
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }
      .chat-box {
        height: 300px;
        overflow-y: auto;
        border-bottom: 1px solid #ddd;
        margin-bottom: 10px;
        padding: 10px;
        display: flex;
        flex-direction: column;
      }
      .message {
        padding: 10px;
        margin: 5px;
        border-radius: 10px;
        max-width: 80%;
        word-wrap: break-word;
        text-align: left;
      }
      .message.tutor {
        align-self: flex-end;
        background: #e6e6e6;
        color: black;
      }
      .message.student {
        align-self: flex-start;
        background: #e6e6e6;
        color: black;
      }
      .file-preview {
        max-width: 100%;
        max-height: 200px;
        border-radius: 5px;
      }
      .input-box {
        display: flex;
        align-items: center;
      }
      input[type="text"],
      input[type="file"] {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      button {
        padding: 10px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 5px;
      }
      button:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <h2 id="chatHeader">Loading...</h2>
      <div class="chat-box" id="chat-box"></div>
      <div class="input-box">
        <input type="text" id="messageInput" placeholder="Type a message" />
        <button onclick="sendMessage()">Send</button>
      </div>
      <div class="input-box">
        <input type="file" id="fileInput" />
        <button onclick="uploadFile()">Upload</button>
      </div>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const chatId = urlParams.get("chatId");
      const studentId = urlParams.get("studentId");

      async function fetchStudentName(studentId) {
        if (!studentId) return;
        try {
          const response = await fetch(`/api/student-tutor-chat/student/${studentId}`);
          const data = await response.json();
          document.getElementById("chatHeader").innerText = data.studentName
            ? `Student: ${data.studentName}`
            : "Chat with Unknown Student";
        } catch (error) {
          console.error("Error fetching student name:", error);
        }
      }
      fetchStudentName(studentId);

      // Retrieve tutor ID from sessionStorage
      let senderId = null;
      let userRole = "tutor";

      const tutorData = sessionStorage.getItem("tutorDetails");
      if (tutorData) {
        senderId = JSON.parse(tutorData).Tutor_ID;
      } else {
        console.error("Tutor data not found in sessionStorage");
      }

      const chatBox = document.getElementById("chat-box");
      let lastMessageCount = 0;
      let firstLoad = true;

      function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      async function loadMessages() {
        const prevScrollHeight = chatBox.scrollHeight;
        const prevScrollTop = chatBox.scrollTop;

        const response = await fetch(
          `/api/student-tutor-chat/messages/${chatId}`
        );
        const messages = await response.json();

        const newMessageArrived = messages.length > lastMessageCount;
        lastMessageCount = messages.length;

        chatBox.innerHTML = "";

        messages.forEach((msg) => {
          const msgDiv = document.createElement("div");
          msgDiv.classList.add("message");

          if (msg.user_role === "tutor") {
            msgDiv.classList.add("tutor");
          } else if (msg.user_role === "student") {
            msgDiv.classList.add("student");
          }

          if (msg.file_url) {
            if (msg.file_type === "image") {
              msgDiv.innerHTML = `<strong>${msg.user_role}:</strong> <br><img src="${msg.file_url}" class="file-preview">`;
            } else if (msg.file_type === "video") {
              msgDiv.innerHTML = `<strong>${msg.user_role}:</strong> <br><video controls class="file-preview"><source src="${msg.file_url}" type="video/mp4"></video>`;
            } else {
              msgDiv.innerHTML = `<strong>${msg.user_role}:</strong> <br><a href="${msg.file_url}" target="_blank">View File</a>`;
            }
          } else {
            msgDiv.innerHTML = `<strong>${msg.user_role}:</strong> ${msg.message}`;
          }

          chatBox.appendChild(msgDiv);
        });

        setTimeout(() => {
          if (firstLoad || newMessageArrived) {
            scrollToBottom();
            firstLoad = false;
          } else {
            chatBox.scrollTop =
              prevScrollTop + (chatBox.scrollHeight - prevScrollHeight);
          }
        }, 50);
      }

      setInterval(loadMessages, 1000);
      loadMessages();

      document
        .getElementById("messageInput")
        .addEventListener("keypress", function (event) {
          if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
          }
        });

      async function sendMessage() {
        if (!senderId) {
          alert("Sender ID not found. Please log in again.");
          return;
        }
        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value.trim();
        if (!message) return;
        await fetch("/api/student-tutor-chat/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ chatId, senderId, userRole, message }),
        });
        messageInput.value = "";
        loadMessages();
        setTimeout(scrollToBottom, 100);
      }

      async function uploadFile() {
        if (!senderId) {
          alert("Sender ID not found. Please log in again.");
          return;
        }
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append("file", file);
        formData.append("chatId", chatId);
        formData.append("senderId", senderId);
        formData.append("userRole", userRole);
        await fetch("/api/student-tutor-chat/upload", {
          method: "POST",
          body: formData,
        });
        fileInput.value = "";
        loadMessages();
        setTimeout(scrollToBottom, 100);
      }
    </script>
  </body>
</html>
